:ruby
  client_id = params[:client_id]
  out_003 = params[:out_003] == 'true' ? true : false
  year = params[:year].to_i
  month = params[:month].to_i
  dns = params[:dn_ary].nil? ? [] : params[:dn_ary].split(',')
  bckgrnd = {"afdv" => "#FFBFF0","ca21" => "#DDDDDD","cb25" => "#DDDDDD","sa57" => "#FFFF99","o139" => "#FFFF99","r25b" => "#BFFFBF","rafn" => "#BFFFBF"}
%p.close{:onclick => "trst.task.destroy()"}
%p.task_title= t('trst_acc_invoice.title') + " - Selectare avize"
%span#hidden_data.hidden{:data => {:task_id => @task.id, :js => "acc.invoice", :action => "query", :client_id => client_id,:year => year, :month => month, :out_003 => out_003.to_s}}
%table{:cellspacing => "0"}
  %thead
    - TrstAccDeliveryNote.asc(:id_date).by_client_id(client_id).monthly(year,month).by_charged(false).by_freights_p03(out_003).each_with_index do |dn,i|
      - if i % 8 == 0
        %tr
      %td.select-dn{:style => "border-right: solid 1px #333333"}
        %input.trigger{:id => dn.id, :type => "checkbox", :checked  => dns.include?(dn.id.to_s)}
        %span.trigger{:title => "#{dn.id_date}\n#{dn.unit.name[1]}\n#{dn.name}\n#{dn.freights_list.join("\n")}",
                      :style => "cursor:pointer; background-color: #{bckgrnd[dn.name.split('_')[1].downcase]}"}= dn.id_main_doc
    %tr
      %td{:colspan => "8"}
        %br
        %span.small= t('trst_acc_invoice.query.thead_01')
        - TrstFirm.first.units.asc(:slug).each do |u|
          %span.small{:style => "border: solid 1px #333333; background-color: #{bckgrnd[u.name[0].downcase]}"}= u.name[1]
        %br
        %span.small= t('trst_acc_invoice.query.thead_02')
    %tbody
      - unless dns.empty?
        %tr
          %td{:colspan => "8"}
            %table{:style => "width:80%; margin: 15px auto 5px;"}
              %tbody.inner
                %tr.ce.st.em
                  - t('trst_acc_invoice.query.tbody').each do |label|
                    %td= label
                - TrstAccDeliveryNote.any_in(:_id  => dns).sum_freights_inv.sort.each do |s|
                  %tr.to-calculate
                    %td.vam
                      %span.freight= s[0]
                    %td.spnr
                      %span= "%.2f" % s[1][1]
                    %td.ce
                      %input.puw{:id => s[1][0], :value => "0.0000"}
                    %td.spnr.st
                      %span 0.00
                %tr.result
                  %td{:colspan => "3"}
                    %span{:onclick => "trst.task.acc.calculatorInv()"} Total
                  %td.ce.st.vam
                    %span 0.00
  %tfoot
    %tr
      %td{:class => "buttons_bottom",:colspan => "8"}
        - unless dns.empty?
          %span{:class => "button post mc-evt"}= t("button.post") + " FacturÄƒ"
        %span{:class => "button cancel mc-evt"}= t("button.cancel")

